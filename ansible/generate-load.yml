---
# Generate load against all bank microservices.
#
# Usage:
#   ansible-playbook -i inventory.yml generate-load.yml
#   ansible-playbook -i inventory.yml generate-load.yml -e duration=60

- name: Generate load for Pyroscope profiling
  hosts: all
  gather_facts: false

  vars:
    duration: 300

  tasks:
    - name: Run load generator script
      ansible.builtin.shell:
        cmd: >
          bash {{ project_dir }}/scripts/generate-load.sh
          http://localhost:8080
          http://localhost:8081
          http://localhost:8082
          http://localhost:8083
          http://localhost:8084
          http://localhost:8085
          http://localhost:8086
          {{ duration }}
      async: "{{ (duration | int) + 60 }}"
      poll: 10
      register: load_result

    - name: Load generation output
      ansible.builtin.debug:
        msg: "{{ load_result.stdout_lines | default(['complete']) }}"
