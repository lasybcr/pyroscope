{
  "annotations": { "list": [] },
  "editable": true,
  "graphTooltip": 2,
  "links": [
    { "title": "Pyroscope Overview", "url": "/d/pyroscope-java-overview", "type": "link" },
    { "title": "Service Comparison", "url": "/d/service-comparison", "type": "link" },
    { "title": "JVM Metrics", "url": "/d/jvm-metrics-deep-dive", "type": "link" },
    { "title": "HTTP Performance", "url": "/d/http-performance", "type": "link" },
    { "title": "Before vs After", "url": "/d/before-after-comparison", "type": "link" }
  ],
  "templating": {
    "list": [
      {
        "name": "service",
        "type": "custom",
        "label": "Service",
        "current": { "text": "All", "value": "$__all" },
        "options": [
          { "text": "All", "value": "$__all", "selected": true },
          { "text": "api-gateway", "value": "api-gateway", "selected": false },
          { "text": "order-service", "value": "order-service", "selected": false },
          { "text": "payment-service", "value": "payment-service", "selected": false },
          { "text": "fraud-service", "value": "fraud-service", "selected": false },
          { "text": "account-service", "value": "account-service", "selected": false },
          { "text": "loan-service", "value": "loan-service", "selected": false },
          { "text": "notification-service", "value": "notification-service", "selected": false }
        ],
        "query": "api-gateway,order-service,payment-service,fraud-service,account-service,loan-service,notification-service",
        "includeAll": true,
        "allValue": ".*"
      },
      {
        "name": "pyroscope_app",
        "type": "custom",
        "label": "Pyroscope Application",
        "current": { "text": "bank-api-gateway", "value": "bank-api-gateway" },
        "options": [
          { "text": "bank-api-gateway", "value": "bank-api-gateway", "selected": true },
          { "text": "bank-order-service", "value": "bank-order-service", "selected": false },
          { "text": "bank-payment-service", "value": "bank-payment-service", "selected": false },
          { "text": "bank-fraud-service", "value": "bank-fraud-service", "selected": false },
          { "text": "bank-account-service", "value": "bank-account-service", "selected": false },
          { "text": "bank-loan-service", "value": "bank-loan-service", "selected": false },
          { "text": "bank-notification-service", "value": "bank-notification-service", "selected": false }
        ],
        "query": "bank-api-gateway,bank-order-service,bank-payment-service,bank-fraud-service,bank-account-service,bank-loan-service,bank-notification-service"
      },
      {
        "name": "profile_type",
        "type": "custom",
        "label": "Profile Type",
        "current": { "text": "cpu", "value": "process_cpu:cpu:nanoseconds:cpu:nanoseconds" },
        "options": [
          { "text": "cpu", "value": "process_cpu:cpu:nanoseconds:cpu:nanoseconds", "selected": true },
          { "text": "alloc (memory)", "value": "memory:alloc_in_new_tlab_objects:count:space:bytes", "selected": false },
          { "text": "mutex (lock)", "value": "mutex:contentions:count:mutex:count", "selected": false },
          { "text": "wall", "value": "wall:wall:nanoseconds:cpu:nanoseconds", "selected": false }
        ],
        "query": "process_cpu:cpu:nanoseconds:cpu:nanoseconds,memory:alloc_in_new_tlab_objects:count:space:bytes,mutex:contentions:count:mutex:count,wall:wall:nanoseconds:cpu:nanoseconds"
      }
    ]
  },
  "panels": [
    {
      "id": 100,
      "title": "Service Architecture",
      "type": "text",
      "gridPos": { "h": 3, "w": 24, "x": 0, "y": 0 },
      "options": {
        "mode": "markdown",
        "content": "| Service | Verticle | Endpoints | Pyroscope App |\n|---------|----------|-----------|---------------|\n| **api-gateway** | MainVerticle | /cpu, /alloc, /redis, /json, /batch, /mixed | `bank-api-gateway` |\n| **order-service** | OrderVerticle | /order/create, /order/process | `bank-order-service` |\n| **payment-service** | PaymentVerticle | /payment/transfer, /payment/fx, /payment/orchestrate | `bank-payment-service` |\n| **fraud-service** | FraudDetectionVerticle | /fraud/score, /fraud/ingest, /fraud/anomaly | `bank-fraud-service` |\n| **account-service** | AccountVerticle | /account/balance, /account/deposit, /account/interest | `bank-account-service` |\n| **loan-service** | LoanVerticle | /loan/apply, /loan/amortize, /loan/risk-sim | `bank-loan-service` |\n| **notification-service** | NotificationVerticle | /notify/send, /notify/bulk, /notify/drain | `bank-notification-service` |"
      }
    },
    {
      "id": 1,
      "title": "Request Rate by Service",
      "description": "HTTP request rate per service, filtered by the Service dropdown.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 3 },
      "targets": [
        {
          "expr": "sum by (instance) (rate(vertx_http_server_requests_total{job=\"vertx-apps\", instance=~\"$service:8080\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps", "custom": { "fillOpacity": 15, "lineWidth": 2 } }
      }
    },
    {
      "id": 2,
      "title": "Avg Latency by Service",
      "description": "Average response time per service.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 3 },
      "targets": [
        {
          "expr": "sum by (instance) (rate(vertx_http_server_response_time_seconds_sum{job=\"vertx-apps\", instance=~\"$service:8080\"}[1m])) / sum by (instance) (rate(vertx_http_server_response_time_seconds_count{job=\"vertx-apps\", instance=~\"$service:8080\"}[1m]))",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s", "custom": { "fillOpacity": 15, "lineWidth": 2 } }
      }
    },
    {
      "id": 3,
      "title": "Request Rate by Route",
      "description": "Per-route request rate across selected services.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 11 },
      "targets": [
        {
          "expr": "sum by (route) (rate(vertx_http_server_requests_total{job=\"vertx-apps\", instance=~\"$service:8080\", route!=\"\", route!~\"/health|/metrics\"}[1m]))",
          "legendFormat": "{{route}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps", "custom": { "fillOpacity": 10, "lineWidth": 2 } }
      }
    },
    {
      "id": 5,
      "title": "Slowest Routes (Top 10)",
      "description": "Routes with highest average latency across all services.",
      "type": "bargauge",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 19 },
      "targets": [
        {
          "expr": "topk(10, sum by (route) (rate(vertx_http_server_response_time_seconds_sum{job=\"vertx-apps\", instance=~\"$service:8080\", route!=\"\", route!~\"/health|/metrics\"}[5m])) / sum by (route) (rate(vertx_http_server_response_time_seconds_count{job=\"vertx-apps\", instance=~\"$service:8080\", route!=\"\", route!~\"/health|/metrics\"}[5m])))",
          "legendFormat": "{{route}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 0.1 }, { "color": "red", "value": 0.5 }] } }
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "reduceOptions": { "calcs": ["lastNotNull"] } }
    },
    {
      "id": 6,
      "title": "Error Rate by Route",
      "description": "5xx error rates grouped by route.",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 19 },
      "targets": [
        {
          "expr": "sum by (route) (rate(vertx_http_server_requests_total{job=\"vertx-apps\", instance=~\"$service:8080\", route!=\"\", code=~\"5..\"}[1m]))",
          "legendFormat": "{{route}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "reqps", "custom": { "fillOpacity": 30, "lineWidth": 2 }, "color": { "mode": "palette-classic" } }
      }
    },
    {
      "id": 10,
      "title": "JVM CPU by Service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 27 },
      "targets": [
        {
          "expr": "rate(process_cpu_seconds_total{job=\"jvm\", instance=~\"$service:9404\"}[1m])",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "percentunit", "custom": { "fillOpacity": 15, "lineWidth": 2 } }
      }
    },
    {
      "id": 11,
      "title": "JVM Heap by Service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 27 },
      "targets": [
        {
          "expr": "sum by (instance) (jvm_memory_used_bytes{job=\"jvm\", area=\"heap\", instance=~\"$service:9404\"})",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "bytes", "custom": { "fillOpacity": 15, "lineWidth": 2 } }
      }
    },
    {
      "id": 12,
      "title": "GC Pause Rate by Service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 7, "w": 12, "x": 0, "y": 34 },
      "targets": [
        {
          "expr": "sum by (instance, gc) (rate(jvm_gc_collection_seconds_sum{job=\"jvm\", instance=~\"$service:9404\"}[1m]))",
          "legendFormat": "{{instance}} — {{gc}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "unit": "s", "custom": { "fillOpacity": 20, "drawStyle": "bars" } }
      }
    },
    {
      "id": 13,
      "title": "Thread Count by Service",
      "type": "timeseries",
      "datasource": { "type": "prometheus", "uid": "prometheus-ds" },
      "gridPos": { "h": 7, "w": 12, "x": 12, "y": 34 },
      "targets": [
        {
          "expr": "jvm_threads_current{job=\"jvm\", instance=~\"$service:9404\"}",
          "legendFormat": "{{instance}}"
        }
      ],
      "fieldConfig": {
        "defaults": { "custom": { "fillOpacity": 10 } }
      }
    },
    {
      "id": 20,
      "title": "Flame Graph — $pyroscope_app ($profile_type)",
      "description": "Continuous profiling flame graph. Use the Pyroscope Application and Profile Type dropdowns to switch between services.",
      "type": "flamegraph",
      "datasource": { "type": "grafana-pyroscope-datasource", "uid": "pyroscope-ds" },
      "gridPos": { "h": 14, "w": 24, "x": 0, "y": 41 },
      "targets": [
        {
          "profileTypeId": "$profile_type",
          "labelSelector": "{service_name=\"$pyroscope_app\"}"
        }
      ]
    }
  ],
  "schemaVersion": 39,
  "tags": ["service", "profiling", "comparison", "vertx"],
  "time": { "from": "now-1h", "to": "now" },
  "title": "Service Performance",
  "uid": "verticle-performance"
}
